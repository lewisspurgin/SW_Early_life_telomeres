---
output: word_document
---
```{r setwd, include = F}

#Set working directory up one level
setwd('..')



#Load and clean data
source('Scripts/SW juvenile telomeres IPC load.r')
source('Scripts/SW juvenile telomeres IPC functions.r')
source('Scripts/SW juvenile telomeres IPC clean.r')


#Set some options
options(na.action='na.fail')
opts_knit$set(root.dir = getwd())
opts_chunk$set(echo=FALSE,
               warning=FALSE,
               message=FALSE,
               fig.path='../Figures/',
               fig.width= 4,
               fig.height= 8,
               fig.show='asis',
               dev='png')



```

**Figure Legends**

**Figure 1** Factors affecting telomere length in juvenile Seychelles warblers. **A** Model averaged estimates and 95% confidence intervals (points and error bars, respectively) for all explanatory terms used in a linear model with juvenile telomere length as the response variable. Numbers in brackets are the relative importance of each term in the top model set (see main text for details; Food av = annual food availability, TQ = territory quality). **B** Annual food availability and **C** body condition in relation to telomere length. Points and error bars in **A** are mean $\pm$ 95% confidence interval telomere lengths for each year or group size (means are used for plotting purposes only), and the lines represent fitted values and from linear regressions.

**Figure 2** Juvenile telomere length and lifespan in Seychelles warblers. **A** Model averaged estimates and 95% confidence intervals (points and error bars, respectively) for all explanatory terms used in a generalised linear model with a poisson error structure and lifespan as the response variable. Only juveniles that survived their first year of life were included in the model. Numbers in brackets are the relative importance of each term in the top model set (see main text for details). Food av = annual food availability, TL = telomere length TQ = territory quality. **B** Raw telomere length and annual food availability in relation to lifespan. Annual food availability was modeled as a covariate (see main text for details) but is plotted as a factor here for visualisation purposes. The lines represent fitted values from a Poisson regression.




PAGEBREAK

**Figure 1**

```{r Figure 1,fig.width=8,fig.height=9}


###########
#Fig 1A



#Run the model
lm1 <- lmer(TLKB ~ TQspace + Insect + NonHelper + Sex + Tarsus + BodyMass + Helper + (1|LayYear),
            data = chickall,REML=FALSE)

lm1 <- standardize(lm1)


#Model averaging
lm2 <- dredge(lm1)
lmavg <- model.avg(lm2,subset = delta <=6)
myimp <- importance(lmavg) #Relative importance of each explanatory variable
  

#Put it all into a nice table
table1 <- imptable(lmavg,myimp)
table1 <- signif(table1,2)


#Sort out row/col names
nams <- rownames(table1)
nams[nams == 'c.Ageclass'] <- 'Age class'
nams[nams == 'z.BodyMass'] <- 'Body mass'
nams[nams == 'z.Tarsus'] <- 'Tarsus'
nams[nams == 'z.NonHelper'] <- 'Non helpers'
nams[nams == 'c.Sex'] <- 'Sex'
nams[nams == 'z.Insect'] <- 'Food av.'
nams[nams == 'z.TQspace'] <- 'TQ'
nams[nams == 'z.Helper'] <- 'Helpers'

rownames(table1) <- nams
colnames(table1) <- c('Estimate','SE','2.5%','97.5%','RI')

table1 <- data.frame(table1,myx=row.names(table1))

Fig1A <- forestplot(table1) +
  annotate('text',x=0.5,y=4,label='A')

######################################
temp <- chickall
temp$Helper <- ifelse(temp$Helper>0,'Helpers present','Helpers absent')


ddFig1B <- ddply(temp,
                 .(Helper),
                 summarize,
                 TLKBmean = mean(TLKB),
                 TLKBse = se(TLKB))

Fig1B <- ggplot(ddFig1B,
       aes(x = Helper,
           y = TLKBmean)) +
  ylab('Telomere length (kb)') + 
  xlab('') +
  theme_classic() +
  theme(axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14), 
        axis.title.y = element_text(size = 16,vjust=0.8),
        axis.title.x = element_text(size = 16)) +
  geom_pointrange(aes(ymin=TLKBmean-TLKBse,ymax=TLKBmean+TLKBse)) +
  scale_colour_manual(values = wes_palette("Royal1")) +
  annotate('text',x=0.5,y=7.5,label='B')


Fig1C <- ggplot(chickall,
       aes(x = BodyMass,
           y = TLKB)) +
  ylab('Telomere length (kb)') + 
  xlab('Body mass (g)') +
  theme_classic() +
  theme(axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14), 
        axis.title.y = element_text(size = 16,vjust=0.8),
        axis.title.x = element_text(size = 16)) +
  geom_point() +
  stat_smooth(method = 'lm',col = 'black') +
  annotate('text',x=12,y=15,label='C')

multiplot(Fig1A,Fig1B,Fig1C,layout=matrix(c(1,1,1,1,1,1,2,3,2,3), nrow=5, byrow=TRUE))


```


PAGEBREAK

```{r Figure 2,fig.width=5,fig.height=9}
###########
#Fig 2A



#Run the model
lm1 <- lmer(TLKB ~ TQspace + Insect + NonHelper + Sex + Tarsus + BodyMass + Helper + (1|LayYear),
            data = FlSAall,REML=FALSE)

lm1 <- standardize(lm1)


#Model averaging
lm2 <- dredge(lm1)
lmavg <- model.avg(lm2,subset = delta <=6)
myimp <- importance(lmavg) #Relative importance of each explanatory variable
  

#Put it all into a nice table
table1 <- imptable(lmavg,myimp)
table1 <- signif(table1,2)



#Sort out row/col names
nams <- rownames(table1)
nams[nams == 'c.Ageclass'] <- 'Age class'
nams[nams == 'z.BodyMass'] <- 'Body mass'
nams[nams == 'z.Tarsus'] <- 'Tarsus'
nams[nams == 'z.NonHelper'] <- 'Non helpers'
nams[nams == 'c.Sex'] <- 'Sex'
nams[nams == 'z.Insect'] <- 'Food av.'
nams[nams == 'z.TQspace'] <- 'TQ'
nams[nams == 'z.Helper'] <- 'Helpers'


rownames(table1) <- nams
colnames(table1) <- c('Estimate','SE','2.5%','97.5%','RI')

table1 <- data.frame(table1,myx=row.names(table1))

Fig2A <- forestplot(table1) +
  annotate('text',x=0.5,y=4,label='A')


######################################
temp <- FlSAall
temp$Insect <- factor(temp$Insect)

ddFig2B <- ddply(temp,
                 .(Insect),
                 summarize,
                 TLKBmean = mean(TLKB),
                 TLKBse = 1.96*se(TLKB))
ddFig2B <- droplevels(ddFig2B[complete.cases(ddFig2B),])
ddFig2B$Insect <- as.numeric(paste(ddFig2B$Insect))

Fig2B <- ggplot(ddFig2B,
       aes(x = Insect,
           y = TLKBmean)) +
  ylab('Telomere length (kb)') + 
  xlab('Annual food availability') +
  theme_classic() +
  theme(axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14), 
        axis.title.y = element_text(size = 16,vjust=0.8),
        axis.title.x = element_text(size = 16)) +
  stat_smooth(data=FlSAall,aes(x=Insect,y=TLKB),method=lm,col='black',se=T) +
  geom_pointrange(aes(ymin=TLKBmean-TLKBse,ymax=TLKBmean+TLKBse)) +
  scale_colour_manual(values = wes_palette("Royal1")) +
  annotate('text',x=2,y=10,label='B')


multiplot(Fig2A,Fig2B)


```

PAGEBREAK





**Figure 2**

```{r Figure 3}

s1 <- with(FlSAall,flexsurvreg(Surv(Lifespan+1,Died)~TLKB+Insect, dist="lnorm"))
t1 <- data.frame(s1$res)
t1 <- t1[3:5,]
t1 <- t1[order(rownames(t1)),]
rownames(t1) <- c('Food av.','Tel. length')

Fig2A <- ggplot(t1,aes(x = rownames(t1),y = est)) +
  geom_point() + 
  geom_pointrange(aes(ymin = L95.,ymax = U95.)) +
    theme_classic() +
  ylab('Estimate') + 
  xlab('') + 
  theme_classic() +
  theme(axis.text.x = element_text(angle=90,size = 14), 
        axis.text.y = element_text(size = 14), 
        axis.title.y = element_text(size = 16,vjust=0.8),
        axis.title.x = element_text(size = 16),
        legend.position = c(0.8,0.8),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12)) +
  geom_abline(intercept = 0,slope = 0,lty=2) +
  annotate('text',x=0.6,y=0.15,label='A')



s1 <- survfit(Surv(time = Lifespan+1, event = Died)~TLF, data = FlSA)
Fig2B <- ggsurv(s1,plot.cens=F) + 
  theme_classic() +
  ylab('Proportion survived') + 
  xlab('Age (years)') + 
  theme_classic() +
  theme(axis.text.x = element_text(size = 14), 
        axis.text.y = element_text(size = 14), 
        axis.title.y = element_text(size = 16,vjust=0.8),
        axis.title.x = element_text(size = 16),
        legend.position = c(0.8,0.8),
        legend.text = element_text(size = 12),
        legend.title = element_blank()) +
  scale_colour_manual(name = 'TL',
                      values = c('darkred','red')) +
  guides(linetype=F) +
  annotate('text',x=0.5,y=1.1,label='B')

multiplot(Fig2A,Fig2B)

```