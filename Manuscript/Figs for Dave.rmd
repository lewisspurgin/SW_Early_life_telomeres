---
  output:
  word_document:
  reference_docx: myref.docx
---

```{r setup, include = F}

rm(list=ls())

#Load knitr
library(knitr)

#Set some options
options(na.action='na.fail')
opts_knit$set(root.dir = '..')
opts_chunk$set(include=FALSE,
               message=FALSE,
               fig.show='hide')

```

```{r load and clean, include = F}


#Load and clean data
source('Scripts/SW juvenile telomeres IPC load.r')
source('Scripts/SW juvenile telomeres IPC functions.r')
source('Scripts/SW juvenile telomeres IPC clean.r')
source('Scripts/SW juvenile telomeres IPC models.r')


```








**Table 1** Telomere dynamics and age in Seychelles warbler cohorts. Linear mixed models were created with RTL as the response variable, and different measures of age, cohort ID, and cohort x age interactions as explanatory variables (see methods for details). Models are ranked by AICc, with best models at the top of the table.

```{r Table 1,include = T,echo = F,warning = F}
RTL_Age_Dredge <- dredge(RTL_Age,
                         subset = !(LogAge & FAge) & 
                           !(LogAge & Agemonths) &
                           !(LogAge & Age2) &
                           !(Agemonths & FAge) & 
                           !(Agemonths & Age2) &
                           !(FAge & Age2))

t1 <- as.matrix(RTL_Age_Dredge)

#Sort out row/col names
nams <- colnames(t1)

nams[nams == 'Agemonths'] <- 'Age (linear)'
nams[nams == 'LogAge'] <- 'Age (log)'
nams[nams == 'FAge'] <- 'Age (factor)'
nams[nams == 'Cohort:FAge'] <- 'Age (factor)*cohort'
nams[nams == 'Agemonths:Cohort'] <- 'Age (continuous)*cohort'
nams[nams == 'Cohort:LogAge'] <- 'Age (log)*cohort'
nams[nams == 'Age2:Cohort'] <- 'Age (quadratic)*cohort'
nams[nams == 'Age2'] <- 'Age (quadratic)'

colnames(t1) <- nams

table1A <- data.frame(Model = apply(t1,1,getterms,c(2:10)),t1[,c('df','AICc','delta','weight')],stringsAsFactors = FALSE)
colnames(table1A) <- c('Model','df','AICc', 'Delta AICc','Weight')
rownames(table1A) <- NULL
table1A$Model[table1A$Model == ''] <- 'Null model'
table1A[,3:5] <- lapply(table1A[,3:5],as.numeric)
table1A[,3:5] <- round(table1A[,3:5],3)


RTL_DeltaAge_Dredge <- dredge(RTL_DeltaAge,
                              subset = !(DeltaLogAge & DeltaAge) &
                                !(DeltaLogAge & DeltaAge2) &
                                !(DeltaAge & DeltaAge2))

t1 <- as.matrix(RTL_DeltaAge_Dredge)

#Sort out row/col names
nams <- colnames(t1)

nams[nams == 'DeltaAge'] <- 'Delta age (linear)'
nams[nams == 'DeltaLogAge'] <- 'Delta age (log)'
nams[nams == 'Cohort:DeltaAge'] <- 'Delta age (continuous)*cohort'
nams[nams == 'Cohort:DeltaLogAge'] <- 'Delta age (log)*cohort'
nams[nams == 'Cohort:DeltaAge2'] <- 'Delta age (quadratic)*cohort'
nams[nams == 'DeltaAge2'] <- 'Delta age (quadratic)'

colnames(t1) <- nams

table1B <- data.frame(Model = apply(t1,1,getterms,c(2:8)),t1[,c('df','AICc','delta','weight')],stringsAsFactors = FALSE)
colnames(table1B) <- c('Model','df','AICc', 'Delta AICc','Weight')
rownames(table1B) <- NULL
table1B$Model[table1B$Model == ''] <- 'Null model'
table1B[,3:5] <- lapply(table1B[,3:5],as.numeric)
table1B[,3:5] <- round(table1B[,3:5],3)

#Sort out rounding and exlcude NAs from blank spaces. Clunky but works
table1 <- rbind(c('A',rep('-',4)),table1A,c('B',rep('-',4)),table1B)

kable(table1,digits = 3)
```



**Figure Legends**
  
  **Figure 1** Telomere dynamics in relation to age in Seychelles warbler cohorts. **A** RTL and age across all individuals. Points and  thin grey lines represent individual samples and birds, respectively. The thick line and shaded area represent the fitted values and 95% confidence limits of a linear regression of RTL and log-transformed age.**B** Boxplot of variation in RTL among cohorts. For visualisation purposes a selection of cohorts with large sample sizes across a wide age range was chosen, but all cohorts were included in models. **C** RTL and age among cohorts. Lines represent fitted values from a linear regression and log-transformed age, and colours correspond to **B**. **D** RTL in relation to and $\Delta$Log age (i.e. within indiviual variation in log age).

**Figure 2** Longitudinal telomere dynamics in the Seychelles warbler. **A** Variation in RTL within individuals sampled at different time points. The dotted line represents parity, and thus points above and below the line represent increases and decreases in RTL, respectively. **B** Scaled density plots of repeated RTL measurements among individual samples, and among different samples taken from the same individual.

**Figure 3** Telomere length in relation to the social and ecological environment in the Seychelles warbler. **A** Estimates and 95% confidence intervals for all explanatory variables fitted in a linear mixed model (see methods for details). **B** RTL in relation to tarsus length and sex. **C** RTL in relation to variation in annual food availability. Lines and shaded areas represent the fitted values and 95% confidence limits from linear regressions.


```{r Figure 1}

pdf('Figures/Figures for Dave NERC grant.pdf',
    width = 5,
    height = 5,
    paper = 'a4')

c15 <- c("dodgerblue2","#E31A1C", # red
         "green4",
         "#FF7F00", # orange
         "gold1",
         "skyblue2", # lt pink
         "palegreen2",
         "#FDBF6F", # lt orange
         "gray70", "khaki2","blue1","steelblue4",
         "darkturquoise",
         "darkorange4","brown","navy",
         'yellow','green','khaki3','blue','pink','orange')

transform(dd,Cohort = factor(LayYear)) %>%
  ddply(.(LayYear),
        summarise,
        meanRTL = mean(RTL),
        seRTL = se(RTL)) %>%
  ggplot(aes(y = meanRTL,x = LayYear))+
  xlab('Birth year') +
  ylab('RTL')+
  geom_point()+
  geom_line()+
  geom_errorbar(aes(ymax = meanRTL+seRTL,ymin=meanRTL-seRTL),width =0.2)+
  theme_classic() +
  theme(axis.text.x = element_text(size = 12,angle = 90), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'none') +
  scale_fill_manual(values = c15)


transform(dd,Cohort = factor(LayYear)) %>%
  subset(Cohort %in% c(2001,2005,2010)) %>%
  ggplot(aes(y = RTL,x = Agemonths, col = Cohort,fill = Cohort))+
  xlab('Age (years)') +
  xlim(c(0,6))+
  geom_smooth(method = 'lm', formula = y~log(x),se = T,fullrange=T,alpha = 0.1) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'top') +
  scale_color_manual(values = c15)+
  scale_fill_manual(values = c15)


ddply(dd,
      .(Insect),
      summarise,
      meanRTL = mean(RTL),
      seRTL = se(RTL)) %>%
ggplot(aes(y = meanRTL,
              x=Insect)) +
  ylab('RTL') + 
  xlab('Insect abundance') +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'none') +
  geom_point()+
  geom_errorbar(aes(ymin=meanRTL-seRTL,ymax=meanRTL+seRTL))+
  stat_smooth(method = 'lm',col = 'darkgrey')


dev.off()


```