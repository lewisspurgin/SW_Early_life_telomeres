---
output:
  word_document:
    reference_docx: myref.docx
---
```{r setup, include = F}

rm(list=ls())

#Load knitr
library(knitr)

#Set some options
options(na.action='na.fail')
opts_knit$set(root.dir = '..')
opts_chunk$set(include=FALSE,
               message=FALSE,
               fig.show='hide')

```

```{r load and clean, include = F}


#Load and clean data
source('Scripts/SW juvenile telomeres IPC load.r')
source('Scripts/SW juvenile telomeres IPC functions.r')
source('Scripts/SW juvenile telomeres IPC clean.r')


```

**Figure Legends**

**Figure 1** RTL in relation to **(A)** age and **(B)** $\Delta$Age in Seychelles warblers. Lines and shaded areas are fitted values and 95% confidence limits from linear regressions.

**Figure 2** Cohort effects on early-life RTL in Seychelles warblers. **A** temporal variation RTL in major and minor cohorts, **B** temporal variation in adult population size, and **C** early-life RTL in relation to cohort-level variation in adult population size. Lines and shaded areas in **C** are fitted values and 95% confidence limits from general linear models.

**Figure 3** Factors affecting early-life RTL in Seychelles warblers. **A** Model averaged estimates and 95% confidence intervals for explanatory terms used in a linear mixed model with RTL as the response variable (see main text for details; TQ = territory quality). **B,C** Early-life RTL and age in relation to tarsus length (**B**) and sex (**C**). Lines and shaded areas in **B** are fitted values and 95% confidence limits from a general linear model.

**Figure 4** Longitudinal telomere dynamics in juvenile Seychelles warblers. **A** Juvenile telomere length in relation to adult telomere length measured in the same individual. **B** $\Delta$RTL in relation to the time between sampling events. Lines and shaded areas represent fitted values and 95% confidence limits from general linear models. Raw data have been ommited from **B** for the sake of clarity, but are plotted in Figure S1.

**Figure 5** Factors affecting $\Delta$RTL in juvenile Seychelles warblers. **A** Model averaged estimates and 95% confidence intervals for explanatory terms used in a linear mixed model with $\Delta$RTL as the response variable (see main text for details; TQ = territory quality). **B** $\Delta$RTL in relation to tarsus length and sex.



```{r Figure 1}

temp <- dd


Fig1A <- ggplot(temp,aes(x = Agemonths,y = RTL))+
  ylab('RTL') + 
  xlab('Age (months)') +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
                axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'none')+
  geom_point(col='grey')+
  stat_smooth(method = 'lm',col='darkgrey')+
  annotate('text',x = 1,y = 2.1,label = 'A')






temp <- subset(dd,DeltaAge !=0)

Fig1B <- ggplot(temp,aes(x = DeltaAge,y = RTL))+
  ylab('RTL') + 
  xlab(expression(Delta*' age (months)')) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'none')+
  geom_point(col='grey')+
  stat_smooth(method = 'lm',col = 'darkgrey')+
  annotate('text',x = -100,y = 2.1,label = 'B')



pdf('Figures/Figure 1.pdf',
    width = 4,
    height = 8,
    paper = 'a4')
multiplot(Fig1A,Fig1B,layout=matrix(c(1,2),nrow = 2,byrow=T))
dev.off()


```








```{r Figure 2}

temp <- juv
temp$LayYear <- factor(temp$LayYear)

Fig2 <- ggplot(temp,aes(x = LayYear,y = RTL))+
  ylab('RTL') + 
  xlab('Cohort') +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12,angle = 90), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
                axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'top')+
  geom_jitter(col = 'grey')+
  geom_boxplot(outlier.colour = NA,notch=F,alpha=0)




pdf('Figures/Figure 2.pdf',
    width = 8,
    height = 4,
    paper = 'a4r')
Fig2
dev.off()


```










```{r Figure 3}

temp <- juv

#Run the model
lm2 <- lmer(RTL ~ Agemonths*(Tarsus) + Helper + NonHelper + Sex + BodyMass  + TQ  + (1|FieldPeriodID) + (1|TerritoryID)+(1|PlateID),
            data = temp,
            REML = FALSE)
lm2 <- standardize(lm2)
#Model averaging

lm3 <- dredge(lm2)
lm3 <- subset(lm3,delta <=6)
lmavg <- model.avg(lm3,fit=T)
myimp <- importance(lmavg) #Relative importance of each explanatory variable
  

#Put it all into a nice table
table2 <- imptable(lmavg,myimp)
table2 <- signif(table2,2)


#Sort out row/col names
nams <- rownames(table2)
nams[nams == 'z.NonHelper'] <- 'Non helpers'
nams[nams == 'c.Sex'] <- 'Sex (males)'
nams[nams == 'z.TQ'] <- 'TQ'
nams[nams == 'c.Helper'] <- 'Helpers'
nams[nams == 'z.BodyMass'] <- 'Body mass'
nams[nams == 'z.Agemonths'] <- 'Age'
nams[nams == 'z.Tarsus'] <- 'Tarsus'
nams[nams == 'c.Season'] <- 'Season (minor)'
nams[nams == 'c.Season:z.Agemonths'] <- 'Age x season'
nams[nams == 'z.Agemonths:z.NonHelper'] <- 'Age x non helpers'
nams[nams == 'c.Sex:z.Agemonths'] <- 'Age x sex'
nams[nams == 'z.Agemonths:z.TQ'] <- 'Age x TQ'
nams[nams == 'c.Helper:z.Agemonths'] <- 'Age x helpers'
nams[nams == 'z.Agemonths:z.BodyMass'] <- 'Age x mass'
nams[nams == 'z.Agemonths:z.Tarsus'] <- 'Age x tarsus'


rownames(table2) <- nams
colnames(table2) <- c('Estimate','SE','2.5%','97.5%','RI')


table2 <- data.frame(table2,myx=row.names(table2))
table2$myx <- factor(table2$myx,levels = table2$myx[order(table2$Estimate,decreasing = T)])

Fig3A <- forestplot(table2)+
  annotate('text',x = 0.6,y = 0.25,label = 'A')+
  theme(axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'))



temp <- juv

temp[,'Helpers'] <- ifelse(temp$Helper>0,'Present', 'Absent')
temp[,'Non helpers'] <- ifelse(temp$NonHelper>0,'Present', 'Absent')
temp[,'Age (months)'] <- factor(temp$Agemonths) 

  
Fig3B <- ggplot(temp,
       aes(x = Tarsus,
           y = RTL,
           colour=`Age (months)`,
           fill = `Age (months)`,
           shape = `Age (months)`)) +
  ylab('RTL') + 
  xlab('Tarsus length (mm)') +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
                axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'top') +
  geom_point()+
  stat_smooth(method = 'lm')+
  scale_colour_manual(values = c('grey','darkorange','darkgreen'))+
  scale_fill_manual(values = c('grey','darkorange','darkgreen'))+
  annotate('text',x = 17,y = 2.1,label = 'B')


Fig3C <- ggplot(temp,
       aes(col = `Age (months)`,
           fill =  `Age (months)`,
           y = RTL,
           x=TQ)) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
                axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'top') +
  geom_point()+
  stat_smooth(method = 'lm')+
  scale_colour_manual(values = c('grey','darkorange','darkgreen'))+
  scale_fill_manual(values = c('grey','darkorange','darkgreen'))+
  annotate('text',x = 3,y = 2.1,label = 'C')



pdf('Figures/Figure 3.pdf',
    width = 8,
    height = 8,
    paper = 'a4r')
multiplot(Fig3A,Fig3B,Fig3C,layout = matrix(c(1,1,2,3),nrow = 2,byrow = T))
dev.off()




```







```{r Figure 4}

temp <- Loss
temp[,'Age (months)'] <- factor(temp$Agemonths)


Fig4A <- ggplot(temp,
       aes(x = RTL,
           y = RTL1)) +
  ylab('Adult RTL') + 
  xlab('Juvenile RTL') +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        legend.position = c(0.82,0.88),
        legend.title = element_text(size = 12),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.background = element_rect(fill = grey(0.9))) +
  geom_point(col='grey')+
  stat_smooth(method = 'lm',col='darkgrey')+
  annotate('text',x = 0,y = 1.8,label = 'A')







temp <- subset(dd,DeltaAge !=0)
reps <- tapply(temp$RTL,temp$BirdID,length)
keep <- names(reps[reps>3])
temp <- subset(temp,BirdID %in% keep)

mins <- tapply(temp$Agemonths,temp$BirdID,min)
keep2 <- names(mins[mins <5])
temp <- subset(temp,BirdID %in% keep2)
temp <- subset(temp,!duplicated(paste0(BirdID,Agemonths)))



Fig4B <- ggplot(temp,aes(x = Agemonths,y = RTL,group = BirdID,col=factor(BirdID)))+
geom_point()+
geom_line()+
  xlab('Age (months)') +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'none')+
  annotate('text',x = -5,y = 2,label = 'B')






#First calculate Delta RTL 
temp <- subset(dd,!duplicated(paste0(BirdID,Agemonths)))
counts <- with(temp,tapply(RTL,BirdID,length))
c3 <- names(counts[counts >= 2])


dd3 <- subset(temp,BirdID %in% c3)

ggplot(dd3,aes(x = Agemonths,y = RTL, group = BirdID))+
  geom_line(alpha = 0.5)

dd3$DeltaRTL <- NA

for(i in 1:nrow(dd3))
{
  cd <- subset(dd3,BirdID == dd3$BirdID[i])
  cd <- cd[order(cd$Agemonths),]
  
  birdpos <- which(cd$BloodID == dd3$BloodID[i])
  
  if(birdpos == 1)
  {
    dd3$DeltaRTL[i] <- 0
  } else
  {
      prevbird <- cd[birdpos-1,'RTL']
  dd3$DeltaRTL[i] <- dd3$RTL[i]-prevbird
  dd3$MidAge[i] <- mean(c(dd3$Agemonths[i],cd[birdpos-1,'Agemonths']))
  dd3$MinAge[i] <- cd[birdpos-1,'Agemonths']
  dd3$TimeDiff[i] <- dd3$Agemonths[i] - cd[birdpos-1,'Agemonths']
  }
  

}

temp <- subset(dd3,DeltaRTL != 0)

boxplot(DeltaRTL~SurvivedNext,data=subset(temp,MinAge>1))
summary(lm(DeltaRTL~RemainingLife,data=subset(temp,MinAge>1)))

plot(DeltaRTL~LayYear,data=subset(temp,MinAge>1 ))

temp <- subset(dd0,!duplicated(paste0(BloodID,RTL)))

temp <- subset(temp,RTL<2)
temp <- subset(temp,RTL > 0.04)

counts <- with(temp,tapply(RTL,BloodID,length))
c3 <- names(counts[counts %in% c(2:5)])


dd3_2 <- subset(temp,BloodID %in% c3)
dd3_2 <- dd3_2[order(dd3_2$BloodID),]
counts <- with(dd3_2,tapply(RTL,BloodID,length))

dd3_2$birdpos <- unlist(sapply(counts,function(x) c(1:x)))

dd3_2$DeltaRTL <- NA

for(i in 1:nrow(dd3_2))
{
  cd <- subset(dd3_2,BloodID == dd3_2$BloodID[i])
  
  if(dd3_2$birdpos[i] == 1)
  {
    dd3_2$DeltaRTL[i] <- 0
  } else
  {
      prevbird <- subset(cd,birdpos == dd3_2$birdpos[i]-1)$RTL
  dd3_2$DeltaRTL[i] <- dd3_2$RTL[i]-prevbird
  }
  

}


dd3 <- subset(dd3,DeltaRTL !=0)
dd3_2 <- subset(dd3_2,DeltaRTL!=0)

dd3_2 <- dd3_2[1:nrow(dd3),]


temp <- data.frame(DeltaRTL = c(dd3$DeltaRTL,dd3_2$DeltaRTL),Group = rep(c('Among samples','Within samples'),c(nrow(dd3),nrow(dd3_2))))


Fig4C <- ggplot(temp,aes(col=Group,fill = Group,x = DeltaRTL, y = ..scaled..))+
    geom_density(alpha = 0.2)+
  theme_classic()+
    theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        legend.position = c(0.22,0.78),
        legend.title = element_blank(),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black')) +
  scale_colour_manual(values = c('darkgrey','gold'))+
  scale_fill_manual(values = c('darkgrey','gold'))+
  geom_vline(xintercept = 0,lty = 2)+
  annotate('text',x = -5,y = 2,label = 'C')





pdf('Figures/Figure 4.pdf',
    width = 4,
    height = 9,
    paper = 'a4')
multiplot(Fig4A,Fig4B,Fig4C,layout=matrix(c(1,2,3),nrow=3,byrow=T))
dev.off()


```















#First calculate Delta RTL 
temp <- subset(dd,!duplicated(paste0(BirdID,Agemonths)))
counts <- with(temp,tapply(RTL,BirdID,length))
c3 <- names(counts[counts >= 2])


dd3 <- subset(temp,BirdID %in% c3)

ggplot(dd3,aes(x = Agemonths,y = RTL, group = BirdID))+
  geom_line(alpha = 0.5)

dd3$DeltaRTL <- NA

for(i in 1:nrow(dd3))
{
  cd <- subset(dd3,BirdID == dd3$BirdID[i])
  cd <- cd[order(cd$Agemonths),]
  
  birdpos <- which(cd$BloodID == dd3$BloodID[i])
  
  if(birdpos == 1)
  {
    dd3$DeltaRTL[i] <- 0
  } else
  {
      prevbird <- cd[birdpos-1,'RTL']
  dd3$DeltaRTL[i] <- dd3$RTL[i]-prevbird
  dd3$MidAge[i] <- mean(c(dd3$Agemonths[i],cd[birdpos-1,'Agemonths']))
  dd3$MinAge[i] <- cd[birdpos-1,'Agemonths']
  dd3$TimeDiff[i] <- dd3$Agemonths[i] - cd[birdpos-1,'Agemonths']
  }
  

}

temp <- subset(dd3,DeltaRTL != 0)

boxplot(DeltaRTL~SurvivedNext,data=subset(temp,MinAge>1))
summary(lm(DeltaRTL~RemainingLife,data=subset(temp,MinAge>1)))

plot(DeltaRTL~LayYear,data=subset(temp,MinAge>1 ))

temp <- subset(dd0,!duplicated(paste0(BloodID,RTL)))

temp <- subset(temp,RTL<2)
temp <- subset(temp,RTL > 0.04)

counts <- with(temp,tapply(RTL,BloodID,length))
c3 <- names(counts[counts %in% c(2:5)])


dd3_2 <- subset(temp,BloodID %in% c3)
dd3_2 <- dd3_2[order(dd3_2$BloodID),]
counts <- with(dd3_2,tapply(RTL,BloodID,length))

dd3_2$birdpos <- unlist(sapply(counts,function(x) c(1:x)))

dd3_2$DeltaRTL <- NA

for(i in 1:nrow(dd3_2))
{
  cd <- subset(dd3_2,BloodID == dd3_2$BloodID[i])
  
  if(dd3_2$birdpos[i] == 1)
  {
    dd3_2$DeltaRTL[i] <- 0
  } else
  {
      prevbird <- subset(cd,birdpos == dd3_2$birdpos[i]-1)$RTL
  dd3_2$DeltaRTL[i] <- dd3_2$RTL[i]-prevbird
  }
  

}


dd3 <- subset(dd3,DeltaRTL !=0)
dd3_2 <- subset(dd3_2,DeltaRTL!=0)

dd3_2 <- dd3_2[1:nrow(dd3),]


temp <- data.frame(DeltaRTL = c(dd3$DeltaRTL,dd3_2$DeltaRTL),Group = rep(c('Among samples','Within samples'),c(nrow(dd3),nrow(dd3_2))))


ggplot(temp,aes(col=Group,fill = Group,x = DeltaRTL))+
    geom_histogram()+
  theme_classic()+
  scale_colour_manual(values = c('darkgrey','gold'))+
  scale_fill_manual(values = c('darkgrey','gold'))+
  geom_vline(xintercept = 0,lty = 2)

