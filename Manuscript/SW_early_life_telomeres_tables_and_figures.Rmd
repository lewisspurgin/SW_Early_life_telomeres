---
output:
  word_document:
    reference_docx: myref.docx
---
```{r setup, include = F}

rm(list=ls())

#Load knitr
library(knitr)

#Set some options
options(na.action='na.fail')
opts_knit$set(root.dir = '..')
opts_chunk$set(include=FALSE,
               message=FALSE,
               fig.show='hide')

```

```{r load and clean, include = F}


#Load and clean data
source('Scripts/SW juvenile telomeres IPC load.r')
source('Scripts/SW juvenile telomeres IPC functions.r')
source('Scripts/SW juvenile telomeres IPC clean.r')
source('Scripts/SW juvenile telomeres IPC models.r')


```





 


**Table 1** Telomere dynamics and age in Seychelles warbler cohorts. Linear mixed models were created with RTL as the response variable, and different measures of age, along with cohort ID, were included as explanatory variables (see methods for details). Models are ranked by AICc, with best models at the top of the table.

```{r Table 1,include = T,echo = F,warning = F}
RTL_Age_Dredge <- dredge(RTL_Age,
                         subset = !(LogAge & FAge) & 
                           !(LogAge & Agemonths) &
                           !(LogAge & Age2) &
                           !(Agemonths & FAge) &
                           !(FAge & Age2) &
                           !(Age2 & !(Agemonths)))
 
t1 <- as.matrix(RTL_Age_Dredge)

#Sort out row/col names
nams <- colnames(t1)

nams[nams == 'Agemonths'] <- 'Age (linear)'
nams[nams == 'MeanAge'] <- 'Age (mean)'
nams[nams == 'LogAge'] <- 'Age (log)'
nams[nams == 'FAge'] <- 'Age (factor)'
nams[nams == 'Cohort:FAge'] <- 'Age (factor)*cohort'
nams[nams == 'Agemonths:Cohort'] <- 'Age (linear)*cohort'
nams[nams == 'Cohort:LogAge'] <- 'Age (log)*cohort'
nams[nams == 'Age2:Cohort'] <- 'Age (quadratic)*cohort'
nams[nams == 'Age2'] <- 'Age (quadratic)'

colnames(t1) <- nams

table1A <- data.frame(Model = apply(t1,1,getterms,c(2:6)),t1[,c('df','AICc','delta','weight')],stringsAsFactors = FALSE)
colnames(table1A) <- c('Model','df','AICc', 'Delta AICc','Weight')
rownames(table1A) <- NULL
table1A$Model[table1A$Model == ''] <- 'Null model'
table1A[,3:5] <- lapply(table1A[,3:5],as.numeric)
table1A[,3:5] <- round(table1A[,3:5],3)


RTL_DeltaAge_Dredge <- dredge(RTL_DeltaAge,
                         subset = MeanAge &
                           !(DeltaLogAge & DeltaAge) &
                           !(DeltaLogAge & DeltaAge2) &
                           !(!(DeltaAge) & DeltaAge2))
 
t1 <- as.matrix(RTL_DeltaAge_Dredge)

#Sort out row/col names
nams <- colnames(t1)

nams[nams == 'DeltaAge'] <- 'Delta age (linear)'
nams[nams == 'DeltaLogAge'] <- 'Delta age (log)'
nams[nams == 'Cohort:DeltaAge'] <- 'Delta age (continuous)*cohort'
nams[nams == 'Cohort:DeltaLogAge'] <- 'Delta age (log)*cohort'
nams[nams == 'Cohort:DeltaAge2'] <- 'Delta age (quadratic)*cohort'
nams[nams == 'DeltaAge2'] <- 'Delta age (quadratic)'

colnames(t1) <- nams

table1B <- data.frame(Model = apply(t1,1,getterms,c(2:6)),t1[,c('df','AICc','delta','weight')],stringsAsFactors = FALSE)
colnames(table1B) <- c('Model','df','AICc', 'Delta AICc','Weight')
rownames(table1B) <- NULL
table1B$Model[table1B$Model == ''] <- 'Null model'
table1B[,3:5] <- lapply(table1B[,3:5],as.numeric)
table1B[,3:5] <- round(table1B[,3:5],3)

#Sort out rounding and exlcude NAs from blank spaces. Clunky but works
table1 <- rbind(c('A',rep('-',4)),table1A,c('B',rep('-',4)),table1B)

kable(table1,digits = 3)
```



**Figure Legends**

**Figure 1** Telomere dynamics in relation to age in Seychelles warbler cohorts. **A** RTL and age across all individuals. Points and  connecting thin grey lines represent individual samples and birds, respectively. The thick line and shaded area represent the fitted values and 95% confidence limits of a linear regression of RTL and log-transformed age. **B** Boxplot of variation in RTL among cohorts. **C** RTL and age among cohorts. Lines represent fitted values from a linear regression of RTL and log-transformed age, and colours correspond to **B**. **D** RTL in relation to and $\Delta$Log age (i.e. within individual variation in log age).

**Figure 2** Longitudinal telomere dynamics in the Seychelles warbler. **A** Variation in RTL within individuals sampled at different time points. The dotted line represents parity, and thus points above and below the line represent increases and decreases in RTL, respectively. **B** Scaled density plots of repeated RTL measurements among individual samples, and among different samples taken from the same individual. Areas of the density plot to the left of the dotted line represent decreases in RTL, while areas to the right represent increases. **C** $\Delta$RTL in relation to age in pairs of samples taken within two years. Black line and shaded area represent fitted values and 05% confidence limits from a linear regression of RTL and log-transformed age. **D** Probability of telomere lengthening occurring in relation to age. Points at zero and one represent pairs of samples where RTL has decreased and increased, respectively, with point size scaled by the number of overlapping values. The black line represents the proportion of samples in which increases in RTL where observed at each age category.

**Figure 3** Telomere length in relation to the social and ecological environment in the Seychelles warbler. **A** Estimates and 95% confidence intervals for all explanatory variables fitted in a linear mixed model (see methods for details). **B** RTL in relation to tarsus length and sex. **C** RTL in relation to variation in annual food availability. Lines and shaded areas represent the fitted values and 95% confidence limits from linear regressions.


```{r Figure 1}

Fig1A <- ddply(dd,
               .(BirdID),
        mutate,
        nreps = length(RTL)) %>%
  subset(nreps>0) %>%
  subset(!duplicated(paste0(BirdID,Agemonths))) %>%
  ggplot(aes(x = Agemonths,y = RTL,group = BirdID,col=factor(BirdID)))+
  geom_point(alpha = 1,col='grey')+
geom_line(col = 'darkgrey',alpha = 0.2)+
  xlab('Age (years)') +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'none')+
  geom_smooth(col = 'black',fill = 'black',lwd = 0.5,aes(group = NULL),method = 'lm',formula = y~log(x))+
  annotate('text',x = 0,y = 1.7,label = 'A')



c15 <- c("dodgerblue2","#E31A1C", # red
                "green4",
                "#FF7F00", # orange
                "gold1",
                "skyblue2", # lt pink
                "palegreen2",
                "#FDBF6F", # lt orange
                "gray70", "khaki2","blue1","steelblue4",
                "darkturquoise",
                "darkorange4","brown","navy",
         'yellow','green','khaki3','blue','pink','orange')

Fig1B <- transform(dd,Cohort = factor(LayYear)) %>%
  ggplot(aes(y = RTL,x = Cohort, fill = Cohort))+
  xlab('Birth year') +
  geom_boxplot(outlier.shape = NA) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12,angle = 90), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'none') +
        scale_fill_manual(values = c15)+
  annotate('text',x = 1,y = 1.6,label = 'B')


Fig1C <- transform(dd,Cohort = factor(LayYear)) %>%
  ggplot(aes(y = RTL,x = Agemonths, col = Cohort,fill = Cohort))+
  xlab('Age (years)') +
  geom_smooth(method = 'lm', formula = y~log(x),se = F) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'none') +
    scale_color_manual(values = c15)+
        scale_fill_manual(values = c15)+
  annotate('text',x = 0,y = 1.3,label = 'C')



  Fig1D <- ggplot(dd3, aes(x = DeltaLogAge,y = RTL))+
  geom_point(alpha = 1,col='grey')+
  xlab(expression(Delta*'Log age (years)')) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'none')+
  geom_smooth(col = 'black',method = 'lm')+
  annotate('text',x = -1.5,y = 1.7,label = 'D')


pdf('Figures/Figure 1.pdf',
    width = 8,
    height = 8,
    paper = 'a4')
multiplot(Fig1A,Fig1B,Fig1C,Fig1D,layout = matrix(1:4,2,2,byrow = T))
dev.off()


```









```{r Figure 2}

temp <- subset(dd3,TimeDiff < 3.5)


Fig2A <- ggplot(dd3,
       aes(x = RTL,
           y = RTL1)) +
  ylab(expression('RTL ('*italic(t)*' + 1)')) + 
  xlab(expression('RTL ('*italic(t)*')')) +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        legend.position = c('none'),
        legend.title = element_text(size = 12),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black')) +
    geom_point(col = "grey")+
  geom_abline(slope = 1,intercept = 0,lty = 2) +
  annotate('text',x = 0.3,y = 1.7,label = 'A')



Fig2B <- ggplot(ddL,aes(col=Group,fill = Group,y = ..scaled..,x = DeltaRTL))+
    geom_density(alpha = 0.2)+
  theme_classic()+
  ylab ('Scaled density')+
  xlab(expression(Delta*'RTL'))+
    theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        legend.position = "top",
        legend.title = element_blank(),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black')) +
  scale_colour_manual(values = c('darkgrey','gold'))+
  scale_fill_manual(values = c('darkgrey','gold'))+
  geom_vline(xintercept = 0,lty = 2) +
  annotate('text',x = -1,y = 1,label = 'B')




Fig2C <- ggplot(temp, aes(x = Agemonths,
           y = DeltaRTL)) +
  ylab(expression(Delta*'RTL'))+
  xlab("Age (years)") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black')) +
  geom_point(col = "grey")+
  geom_smooth(col = 'black',fill = 'black',method = "lm",formula = y~log(x))+
  geom_abline(slope = 0,intercept = 0,lty = 2)+
  annotate('text',x = -0.2,y = 1,label = 'C')


Fig2D <- ddply(temp,
               .(Agemonths),
               summarise,
               PropGainer = mean(DeltaRTLF),
               n = length(DeltaRTLF)) %>%
ggplot(aes(x = Agemonths,
           y = PropGainer)) +
  ylab("Proportion gainers") + 
  xlab("Age (years)") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
        legend.position = c('none'),
        legend.title = element_text(size = 12),
        axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black')) +
  geom_line(col="black")+
  geom_count(data = temp,aes(y = DeltaRTLF,x = Agemonths),col = "grey")+
  annotate('text',x = 0,y = 1.1,label = 'D')

pdf('Figures/Figure 2.pdf',
    width = 7,
    height = 7,
    paper = 'a4')
multiplot(Fig2A,Fig2B,Fig2C,Fig2D,layout = matrix(c(1,2,3,4),nrow = 2,byrow = T))
dev.off()


```



```{r Figure 3}

RTL_Full2 <- standardize(RTL_Full)

CIs <- CIwald(RTL_Full2)
t1a <- data.frame(myx = row.names(CIs)[6:nrow(CIs)],
                  Estimate = fixef(RTL_Full2),
                  X2.5. = CIs[6:nrow(CIs),1],
                  X97.5. = CIs[6:nrow(CIs),2],
                  row.names = NULL,
                  stringsAsFactors = F)

nams <- t1a$myx
nams[nams == 'z.LogAge'] <- 'Log age'
nams[nams == 'z.Tarsus'] <- 'Tarsus length'
nams[nams == 'c.Helper'] <- 'Number helpers'
nams[nams == 'z.GroupSize'] <- 'Group size'
nams[nams == 'c.Sex'] <- 'Sex (males)'
nams[nams == 'z.BodyMass'] <- 'Body mass'
nams[nams == 'z.Insect'] <- 'Insect abundance'
nams[nams == 'z.TQ'] <- 'Territory quality'
nams[nams == 'z.Density'] <- 'Density'

t1a$myx <- nams

t1a$myx <- factor(t1a$myx,levels = t1a$myx[order(t1a$Estimate,decreasing = T)])
t1a <- subset(t1a,myx != "(Intercept)")

Fig3A <- forestplot(t1a,RI = F)+
  annotate('text',y = 0.1,x = 0.6,label = 'A')


Fig3B <- ggplot(dd,
       aes(x = Tarsus,
           y = RTL,
           col = Sex)) +
  geom_point()+
  ylab('RTL') + 
  xlab('Tarsus length (mm)') +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
                axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'top',
        legend.title = element_blank()) +
  stat_smooth(method = 'lm') +
  scale_color_manual(values = c('gold2','red'))+
  annotate('text',x = 17,y = 1.7,label = 'B')

Fig3C <- ggplot(dd,
       aes(y = RTL,
           x=Insect)) +
    ylab('RTL') + 
  xlab('Insect abundance') +
  theme_classic() +
  theme(axis.text.x = element_text(size = 12), 
        axis.text.y = element_text(size = 12), 
        axis.title.y = element_text(size = 14,vjust=0.8),
        axis.title.x = element_text(size = 14),
                axis.line.x = element_line(colour = 'black'),
        axis.line.y = element_line(colour = 'black'),
        legend.position = 'none') +
  geom_boxplot(aes(group = Insect),outlier.shape = NA)+
   stat_smooth(method = 'lm',col = 'darkgrey') +
  annotate('text',x = 2.5,y = 1.6,label = 'C')

pdf('Figures/Figure 3.pdf',
    width = 8,
    height = 8,
    paper = 'a4')
multiplot(Fig3A,Fig3B,Fig3C,layout = matrix(c(1,1,2,3),byrow = T,nrow = 2))
dev.off()

```